#!/bin/bash

OMARELL_PATH="$HOME/.local/share/omarell"

help() {
  source "$OMARELL_PATH/ascii.sh"
  echo
  echo "USAGE:"
  echo "    omarell [COMMAND] [OPTIONS]"
  echo
  echo "COMMANDS:"
  echo "    update         Update Omarell to the latest version"
  echo "    theme          Change and manage system themes"
  echo "    apps           Install, uninstall and manage applications"
  echo "    version, -v    Show the current version of Omarell"
  echo "    help, -h       Show this help message"
  echo
  echo "For more information about a specific command, run:"
  echo "    omarell [COMMAND] --help"
  echo
}

update() {
  # Show help if --help is provided
  if [ "$1" == "--help" ]; then
    echo "USAGE:"
    echo "    omarell update [OPTIONS]"
    echo
    echo "OPTIONS:"
    echo "    --system       Update the entire system"
    echo "    --firmware     Update the system firmware"
    echo "    --help         Show this help message"
    echo
    echo "If no option is provided, it will update Omarell only."
    echo
    exit 0
  fi

  # Perform system update if --system is provided
  if [ "$1" == "--system" ]; then
    echo -e "\e[32m\nUpdating the entire system...\e[0m"
    source "$OMARELL_PATH/bin/scripts/omarell-update-system"
    exit 0
  fi

  # Perform firmware update if --firmware is provided
  if [ "$1" == "--firmware" ]; then
    echo -e "\e[32m\nUpdating firmware...\e[0m"
    source "$OMARELL_PATH/bin/scripts/omarell-update-firmware"
    exit 0
  fi

  # Default update action for Omarell
  echo -e "\e[32m\nUpdating Omarell...\e[0m"
  source "$OMARELL_PATH/bin/scripts/omarell-update"
  exit 0
}

theme() {
  if [ "$1" == "--help" ]; then
    echo "USAGE:"
    echo "    omarell theme [OPTIONS] [THEME_NAME]"
    echo
    echo "OPTIONS:"
    echo "    --help         Show this help message"
    echo
    echo "If no theme name is provided, it will display the theme menu."
    echo
    exit 0
  fi

  if [ -n "$1" ]; then
    source "$OMARELL_PATH/bin/scripts/omarell-theme-set" "$1"
    exit 0
  fi

  source "$OMARELL_PATH/bin/scripts/omarell-theme-menu"
  exit 1
}

apps() {
  # Show help if --help is provided or no arguments are given
  if [ -z "$1" ] || [ "$1" == "--help" ]; then
    echo "USAGE:"
    echo "    omarell apps [install|uninstall] [APP_NAME]"
    echo "OPTIONS:"
    echo "    install        Install an application"
    echo "    uninstall      Uninstall an application"
    echo "    --help         Show this help message"
    echo
    echo "If no APP_NAME is provided, it will display the application menu."
    echo
    exit 0
  fi

  # If install is specified, check if an argument is provided; otherwise, show the menu
  if [ "$1" == "install" ]; then
    if [ -z "$2" ]; then
      source "$OMARELL_PATH/bin/scripts/omarell-apps-install-menu"
      exit 0
    fi

    source "$OMARELL_PATH/bin/scripts/omarell-apps-install" "$2"
    exit 0
  fi

  # If uninstall is specified, check if an argument is provided; otherwise, show the uninstall menu
  if [ "$1" == "uninstall" ]; then
    if [ -z "$2" ]; then
      source "$OMARELL_PATH/bin/scripts/omarell-apps-uninstall-menu"
      exit 0
    fi

    source "$OMARELL_PATH/bin/scripts/omarell-apps-uninstall" "$2"
    exit 0
  fi

  # If no valid command is provided, show the help message
  echo -e "\e[31mInvalid command: $1\e[0m"
  echo "Use 'omarell apps --help' for usage information."
  exit 1
}

refresh() {
  # Show help if --help is provided
  if [ "$1" == "--help" ]; then
    echo "USAGE:"
    echo "    omarell refresh [COMMAND]"
    echo "COMMAND:"
    echo "    applications   Refresh application .desktop files"
    echo "    config         Refresh configuration files"
    echo "    gdm            Refresh GDM background (use current)"
    echo "    --help         Show this help message"
    echo
    echo "This command is used to refresh specific components of Omarell."
    echo
    exit 0
  fi

  # Check if a specific command is provided and source the corresponding script
  if [ -n "$1" ]; then
    script_path="$OMARELL_PATH/bin/scripts/omarell-refresh-$1"
    if [ -f "$script_path" ]; then
      source "$script_path" "${@:2}"
      exit 0
    fi
  fi

  # If no valid command is provided, show the help message
  echo -e "\e[31mInvalid command: $1\e[0m"
  echo "Use 'omarell refresh --help' for usage information."
  exit 1
}

restart() {
  # Show help if --help is provided
  if [ "$1" == "--help" ]; then
    echo "USAGE:"
    echo "    omarell restart [COMMAND]"
    echo "COMMAND:"
    echo "    first-boot     Restart first boot setup (apply for next login)"
    echo "    xcompose       Restart XCompose"
    echo "    --help         Show this help message"
    echo
    echo "This command is used to restart specific components of Omarell."
    echo
    exit 0
  fi

  # Check if a specific command is provided and source the corresponding script
  if [ -n "$1" ]; then
    script_path="$OMARELL_PATH/bin/scripts/omarell-restart-$1"
    if [ -f "$script_path" ]; then
      source "$script_path"
      exit 0
    fi
  fi

  # If no valid command is provided, show the help message
  echo -e "\e[31mInvalid command: $1\e[0m"
  echo "Use 'omarell restart --help' for usage information."
  exit 1
}

version() {
  source "$OMARELL_PATH/bin/scripts/omarell-version"
  exit 0
}

# Check the command and call the appropriate function
case $1 in
  update)
    update "${@:2}" ;;
  theme)
    theme "${@:2}" ;;
  apps)
    apps "${@:2}" ;;
  refresh)
    refresh "${@:2}" ;;
  restart)
    restart "${@:2}" ;;
  version|-v|--version)
    version ;;
  help|-h|--help)
    help ;;
  *)
    help ;;
esac