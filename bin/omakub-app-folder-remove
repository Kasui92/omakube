#!/bin/bash

# omakub-app-folder-remove: Remove an app from a specified folder.
# Usage: omakub-app-folder-remove <desktop_file.desktop> <folder_name>

DESKTOP_DIR="$HOME/.local/share/applications"

if [ "$#" -ne 2 ]; then
  echo -e "\e[32mLet's remove an app from a folder in the app grid!\n\e[0m"
  DESKTOP_FILE=$(gum input --prompt "Name> " --placeholder "A desktop file app (e.g., Spotify.desktop, no full path!)")
  FOLDER_NAME=$(gum input --prompt "Folder> " --placeholder "The folder name (e.g., Utilities)")
else
  DESKTOP_FILE="$1"
  FOLDER_NAME="$2"
fi

if [[ -z "$DESKTOP_FILE" || -z "$FOLDER_NAME" ]]; then
  echo "You must set app name and folder name!"
  exit 1
fi

if [ ! -f "$DESKTOP_DIR/$DESKTOP_FILE" ]; then
  echo "Desktop file '$DESKTOP_FILE' not found!"
  exit 1
fi

# Get current folders list
CURRENT_FOLDERS=$(gsettings get org.gnome.desktop.app-folders folder-children)

# Convert to different formats for checking
FOLDER_LOWERCASE=$(echo "$FOLDER_NAME" | tr -d ' ' | tr '[:upper:]' '[:lower:]')
FOLDER_CAMELCASE=$(echo "$FOLDER_NAME" | tr -d ' ')

# Check if folder exists (try exact name, camelcase, then lowercase)
EXISTING_FOLDER=""
if [[ "$CURRENT_FOLDERS" == *"'$FOLDER_NAME'"* ]]; then
  # Exact name match - use original name for schema
  EXISTING_FOLDER="$FOLDER_NAME"
  FOLDER="$FOLDER_NAME"
elif [[ "$CURRENT_FOLDERS" == *"'$FOLDER_CAMELCASE'"* ]]; then
  # CamelCase match (like "WebApps") - use camelcase for schema
  EXISTING_FOLDER="$FOLDER_CAMELCASE"
  FOLDER="$FOLDER_CAMELCASE"
elif [[ "$CURRENT_FOLDERS" == *"'$FOLDER_LOWERCASE'"* ]]; then
  # Lowercase match - use lowercase for schema
  EXISTING_FOLDER="$FOLDER_LOWERCASE"
  FOLDER="$FOLDER_LOWERCASE"
fi

# Check if folder exists
if [ -z "$EXISTING_FOLDER" ]; then
  echo "Folder '$FOLDER_NAME' does not exist!"
  return 1
fi

# Set schema and get display name
SCHEMA="org.gnome.desktop.app-folders.folder:/org/gnome/desktop/app-folders/folders/$FOLDER/"
FOLDER_DISPLAY_NAME=$(gsettings get "$SCHEMA" name | sed 's/^.\(.*\).$/\1/')

CURRENT_APPS=$(gsettings get "$SCHEMA" apps)

# Check if app exists in folder
if [[ "$CURRENT_APPS" == *"$DESKTOP_FILE"* ]]; then
  TRIMMED=$(echo "$CURRENT_APPS" | sed "s/^\[//;s/\]$//")

  # Parse apps and filter out the one to remove
  NEW_APPS=()
  if [ -n "$TRIMMED" ]; then
    # Split by comma and process each app
    IFS=',' read -ra APPS_ARRAY <<< "$TRIMMED"
    for app in "${APPS_ARRAY[@]}"; do
      # Remove quotes and trim spaces
      cleaned_app=$(echo "$app" | sed "s/^[[:space:]]*'//;s/'[[:space:]]*$//")
      if [[ "$cleaned_app" != "$DESKTOP_FILE" && -n "$cleaned_app" ]]; then
        NEW_APPS+=("'$cleaned_app'")
      fi
    done
  fi

  # Check if folder is empty after removal
  if [[ ${#NEW_APPS[@]} -eq 0 ]]; then
    # Remove the folder from folder-children
    TRIMMED_FOLDERS=$(echo "$CURRENT_FOLDERS" | sed "s/^\[//;s/\]$//")

    NEW_FOLDERS=()
    if [ -n "$TRIMMED_FOLDERS" ]; then
      IFS=',' read -ra FOLDERS_ARRAY <<< "$TRIMMED_FOLDERS"
      for folder in "${FOLDERS_ARRAY[@]}"; do
        # Remove quotes and trim spaces
        cleaned_folder=$(echo "$folder" | sed "s/^[[:space:]]*'//;s/'[[:space:]]*$//")
        if [[ "$cleaned_folder" != "$FOLDER" && -n "$cleaned_folder" ]]; then
          NEW_FOLDERS+=("'$cleaned_folder'")
        fi
      done
    fi

    # Update folder-children list
    if [[ ${#NEW_FOLDERS[@]} -eq 0 ]]; then
      gsettings set org.gnome.desktop.app-folders folder-children "[]"
    else
      FOLDER_LIST=$(IFS=, ; echo "${NEW_FOLDERS[*]}")
      gsettings set org.gnome.desktop.app-folders folder-children "[$FOLDER_LIST]"
    fi

  else
    # Update apps list
    NEW_LIST=$(IFS=, ; echo "${NEW_APPS[*]}")
    gsettings set "$SCHEMA" apps "[$NEW_LIST]"
  fi
else
  echo "App '$DESKTOP_FILE' is not in folder '$FOLDER_DISPLAY_NAME'"
  return 1
fi


