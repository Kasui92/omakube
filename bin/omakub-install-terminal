#!/bin/bash

# Install one of the approved terminals and set it as the default for Omakub (Super + Return etc).

if (($# == 0)); then
  echo "Usage: omakub-install-terminal [alacritty|kitty]"
  exit 1
fi

package="$1"

# Map package name to desktop entry ID
case "$package" in
alacritty) desktop_id="Alacritty.desktop" ;;
kitty) desktop_id="kitty.desktop" ;;
*)
  echo "Unknown terminal: $package"
  exit 1
  ;;
esac

# Install package
if omakub-app-install "$package"; then
  # Set as default terminal
  echo "Setting $package as new default terminal..."
  omakub-env-set TERMINAL "$package"

  # Determine the correct config file name based on desktop environment
  if [ -n "$XDG_CURRENT_DESKTOP" ]; then
    # Use the first desktop name from XDG_CURRENT_DESKTOP (e.g., "ubuntu:GNOME" -> "ubuntu")
    desktop_prefix=$(echo "$XDG_CURRENT_DESKTOP" | cut -d':' -f1 | tr '[:upper:]' '[:lower:]')
    config_file="$HOME/.config/${desktop_prefix}-xdg-terminals.list"
  else
    # Fallback to generic name
    config_file="$HOME/.config/xdg-terminals.list"
  fi

  # Remove all existing xdg-terminals.list files first to ensure clean state
  rm -f "$HOME/.config"/*-xdg-terminals.list "$HOME/.config/xdg-terminals.list" 2>/dev/null

  # Create the current config file with only the selected terminal
  cat > "$config_file" << EOF
# Terminal emulator preference order for xdg-terminal-exec
# The first found and valid terminal will be used
$desktop_id
EOF

  # Copy custom desktop entries with proper X-TerminalArg* keys
  if [ "$package" == "alacritty" ]; then
    mkdir -p ~/.local/share/xdg-terminals ~/.local/share/applications
    cp /usr/share/applications/Alacritty.desktop "$HOME/.local/share/xdg-terminals/Alacritty.desktop"
    cp /usr/share/applications/Alacritty.desktop "$HOME/.local/share/applications/Alacritty.desktop"
  fi
else
  echo "Failed to install $package."
  exit 1
fi
