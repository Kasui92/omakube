#!/bin/bash

if (($# == 0)); then
  echo "Usage: omakub-install-terminal [alacritty|kitty]"
  exit 1
fi

package="$1"

# Map package name to desktop entry ID
case "$package" in
  alacritty)
    desktop_id="Alacritty.desktop"
    ;;
  kitty)
    desktop_id="kitty.desktop"
    ;;
  *)
    echo "Unknown terminal: $package"
    exit 1
    ;;
esac

# Install package
omakub-app-install "$package"

# Set as default terminal
echo "Setting $package as new default terminal..."
omakub-env-set TERMINAL "$package"

# Copy custom desktop entry for alacritty with X-TerminalArg* keys
if [ "$package" = "alacritty" ]; then
  mkdir -p ~/.local/share/xdg-terminals ~/.local/share/applications
  cp "$OMAKUB_PATH/applications/desktop/Alacritty.desktop" ~/.local/share/xdg-terminals/
  cp "$OMAKUB_PATH/applications/desktop/Alacritty.desktop" ~/.local/share/applications/
fi

# Update ubuntu-xdg-terminals.list to prioritize the proper terminal
cat > ~/.config/ubuntu-xdg-terminals.list << EOF
# Terminal emulator preference order for xdg-terminal-exec
# The first found and valid terminal will be used
$desktop_id
EOF

# Restart is needed for new default to take effect
echo
gum confirm "Restart to use new terminal?" && systemctl reboot --no-wall
