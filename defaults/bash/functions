# Create a new directory and enter it
md() {
    mkdir -p $1
    cd $1
}

# Compression
compress() { tar -czf "${1%/}.tar.gz" "${1%/}"; }
alias decompress="tar -xzf"

# Convert webm files generated by the Gnome screenshot video recorder to mp4s that are more compatible
webm2mp4() {
  input_file="$1"
  output_file="${input_file%.webm}.mp4"
  ffmpeg -i "$input_file" -c:v libx264 -vf "pad=ceil(iw/2)*2:ceil(ih/2)*2" -preset slow -crf 22 -c:a aac -b:a 192k "$output_file"
}

# Write iso file to sd card
iso2sd() {
  if [ $# -ne 2 ]; then
    echo "Usage: iso2sd <input_file> <output_device>"
    echo "Example: iso2sd ~/Downloads/ubuntu-25.04-desktop-amd64.iso /dev/sda"
    echo -e "\nAvailable SD cards:"
    lsblk -d -o NAME | grep -E '^sd[a-z]' | awk '{print "/dev/"$1}'
  else
    sudo dd bs=4M status=progress oflag=sync if="$1" of="$2"
    sudo eject $2
  fi
}

# Move a reference to a .desktop file, like Spotify.desktop, to a named folder, like Xtra.
# Don't use full path for the .desktop file.
app2folder() {
  if [ "$#" -ne 2 ]; then
    local FOLDERS=$(gsettings get org.gnome.desktop.app-folders folder-children | tr -d "[],'")
    echo "Usage: app2folder <desktop_file.desktop> <folder_name>"
    echo "Folders: $FOLDERS"
    return 1
  fi

  local DESKTOP_FILE="$1"
  local FOLDER="$2"
  local SCHEMA="org.gnome.desktop.app-folders.folder:/org/gnome/desktop/app-folders/folders/$FOLDER/"
  local CURRENT_APPS=$(gsettings get "$SCHEMA" apps)

  if [[ "$CURRENT_APPS" != *"$DESKTOP_FILE"* ]]; then
    local TRIMMED=$(echo "$CURRENT_APPS" | sed "s/^\[//;s/\]$//")
    gsettings set "$SCHEMA" apps "[$TRIMMED, '$DESKTOP_FILE']"
  fi
}

# Rewmove desktop app from folder
app2folder-remove() {
  if [ "$#" -ne 2 ]; then
    local FOLDERS=$(gsettings get org.gnome.desktop.app-folders folder-children | tr -d "[],'")
    echo "Usage: app2folder-remove <desktop_file.desktop> <folder_name>"
    echo "Folders: $FOLDERS"
    return 1
  fi

  local DESKTOP_FILE="$1"
  local FOLDER="$2"
  local SCHEMA="org.gnome.desktop.app-folders.folder:/org/gnome/desktop/app-folders/folders/$FOLDER/"
  local CURRENT_APPS=$(gsettings get "$SCHEMA" apps)

  if [[ "$CURRENT_APPS" == *"$DESKTOP_FILE"* ]]; then
    local RAW_LIST=$(echo "$CURRENT_APPS" | tr -d "[]'")
    IFS=',' read -ra APPS_ARRAY <<< "$RAW_LIST"

    # Filter out the app to be removed
    local NEW_APPS=()
    for app in "${APPS_ARRAY[@]}"; do
      app=$(echo "$app" | xargs) # trim spaces
      if [[ "$app" != "$DESKTOP_FILE" && -n "$app" ]]; then
        NEW_APPS+=("'$app'")
      fi
    done

    # Join list again
    local NEW_LIST=$(IFS=, ; echo "${NEW_APPS[*]}")

    gsettings set "$SCHEMA" apps "[$NEW_LIST]"
  fi
}

# Ensure that external keyboards that use an fn key has the F keys as the default
alias fix_fkeys='echo 2 | sudo tee /sys/module/hid_apple/parameters/fnmode'

# Spotify window is too large on many displays, so fix this by zooming it down
alias fix_spotify_window_size="sudo sed -i 's|^Exec=.*|Exec=spotify --force-device-scale-factor=1.5 %U|' /usr/local/share/applications/spotify.desktop"

# SSH key management
function ssh-key-put() {
    cat ~/.ssh/id_ed25519.pub | ssh "$1" "mkdir -p ~/.ssh && chmod 700 ~/.ssh && cat >>  ~/.ssh/authorized_keys";
}