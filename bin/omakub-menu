#!/bin/bash

export PATH="$HOME/.local/share/omakub/bin:$PATH"

# Set to true when going directly to a submenu, so we can exit directly
BACK_TO_EXIT=false

back_to() {
  local parent_menu="$1"

  if [[ "$BACK_TO_EXIT" == "true" ]]; then
    exit 0
  elif [[ -n "$parent_menu" ]]; then
    "$parent_menu"
  else
    show_main_menu
  fi
}

menu() {
  local prompt="$1"
  local options="$2"
  local extra="$3"
  local preselect="$4"

  read -r -a args <<<"$extra"

  if [[ -n "$preselect" ]]; then
    options=$(echo -e "$options" | sed "s|^$preselect$|<i>$preselect</i>|")
  fi

  # Show Wofi menu (with markup support)
  selection=$(echo -e "$options" | omakub-wofi \
    --show dmenu \
    --allow-markup \
    --prompt "$prompt..." \
    "${args[@]}" \
    "$wofi_options" 2>>/dev/null)

  echo -e "$selection"
}

terminal() {
  alacritty --class Omakub -e "$@"
}

present_terminal() {
  omakub-launch-terminal-with-presentation "$@"
}

open_in_editor() {
  notify-send "Editing config file" "$1"
  omakub-launch-editor "$1"
}

install_app() {
  present_terminal "echo 'Installing $1...'; omakub-app-install $1"
}

install_terminal() {
  present_terminal "omakub-install-terminal $1"
}

remove_app() {
  present_terminal "echo 'Removing $1...'; omakub-app-remove $1"
}

show_learn_menu() {
  case $(menu "Learn" "  Keybindings\n  Omakub\n  Ubuntu\n  Neovim\n  Zellij\n󱆃  Bash" "--width 250 --height 280") in
  *Keybindings*) omakub-launch-webapp "https://learn.omacom.io/1/read/29/hotkeys" "Omakub Keybindings" ;;
  *Omakub*) omakub-launch-webapp "https://learn.omacom.io/1/read#leaf_40" "Omakub" ;;
  *Ubuntu*) omakub-launch-webapp "https://help.ubuntu.com/" "Ubuntu" ;;
  *Bash*) omakub-launch-webapp "https://devhints.io/bash" "Bash" ;;
  *Neovim*) omakub-launch-webapp "https://www.lazyvim.org/keymaps" "Neovim" ;;
  *Zellij*) omakub-launch-webapp "https://zellij.dev/documentation/keybindings.html" "Zellij" ;;
  *) show_main_menu ;;
  esac
}

show_style_menu() {
  case $(menu "Style" "󰸌  Theme\n  Font\n  Background" "--width 250 --height 180") in
  *Theme*) show_theme_menu ;;
  *Font*) show_font_menu ;;
  *Background*) omakub-theme-bg-next ;;
  *) show_main_menu ;;
  esac
}

show_theme_menu() {
  theme=$(menu "Theme" "$(omakub-theme-list)" "--width 250 --height 470 -O alphabetical" "$(omakub-theme-current)")
  if [[ "$theme" == "CNCLD" || -z "$theme" ]]; then
    back_to show_style_menu
  else
    omakub-theme-set "$theme"
  fi
}

show_font_menu() {
  case $(menu "Font" "  Family\n󰧴  Size" "--width 250 --height 130") in
  *Family*) show_font_family_menu ;;
  *Size*) present_terminal omakub-font-size-set ;;
  *) show_main_menu ;;
  esac
}

show_font_family_menu() {
  font=$(menu "Font" "$(omakub-font-list)" "--width 350" "$(omakub-font-current)")
  if [[ "$font" == "CNCLD" || -z "$font" ]]; then
    back_to show_style_menu
  else
    omakub-font-set "$font"
  fi
}

show_setup_menu() {
  case $(menu "Setup" "  Folders\n  Keybindings\n  Starship\n  Zellij\n󰌧  Wofi\n󰞅  XCompose" "--width 250 --height 280") in
  *Folders*) show_setup_folders_menu ;;
  *Keybindings*) show_setup_keybindings_menu ;;
  *Starship*) edit_in_nvim ~/.config/starship.toml ;;
  *Zellij*) edit_in_nvim ~/.config/zellij/config.kdl ;;
  *Wofi*) edit_in_nvim ~/.config/wofi/config ;;
  *XCompose*) open_in_editor ~/.XCompose && omakub-restart-xcompose ;;
  *) show_main_menu ;;
  esac
}

show_setup_folders_menu() {
  case $(menu "Folders" "󰮝  Add\n󰮞  Remove" "--width 250 --height 120") in
  *Add*) present_terminal omakub-app-folder-add ;;
  *Remove*) present_terminal omakub-app-folder-remove ;;
  *) show_setup_menu ;;
  esac
}

show_setup_keybindings_menu() {
  case $(menu "Keybindings" "   Add\n   Remove" "--width 250 --height 120") in
  *Add*) present_terminal omakub-keybinding-add ;;
  *Remove*) present_terminal omakub-keybinding-remove ;;
  *) show_setup_menu ;;
  esac
}

show_install_menu() {
  case $(menu "Install" "  Web App\n  TUI\n  Service\n  Browser\n  Utility\n  Style\n󰵮  Development\n  Editor\n  Terminal\n󱚤  AI\n  Gaming" "--width 250 --height 470") in
  *Web*) present_terminal omakub-webapp-install ;;
  *TUI*) present_terminal omakub-tui-install ;;
  *Service*) show_install_service_menu ;;
  *Browser*) show_install_browser_menu ;;
  *Utility*) show_install_utility_menu ;;
  *Style*) show_install_style_menu ;;
  *Development*) show_install_development_menu ;;
  *Editor*) show_install_editor_menu ;;
  *Terminal*) show_install_terminal_menu ;;
  *AI*) show_install_ai_menu ;;
  *Gaming*) show_install_gaming_menu ;;
  *) show_main_menu ;;
  esac
}

show_install_service_menu() {
  case $(menu "Install" "  1password\n  Audacity\n  Discord\n  Dropbox\n  GeekBench\n  Gimp\n  LibreOffice\n  LocalSend\n  Obsidian\n  Signal\n  Spotify\n  Typora\n  Tailscale\n  Virtualbox\n  Zoom" "--width 250 --height 600") in
  *1password*) install_app "1password" ;;
  *Audacity*) install_app "audacity" ;;
  *Discord*) install_app "discord" ;;
  *Dropbox*) install_app "dropbox" ;;
  *GeekBench*) install_app "geekbench" ;;
  *Gimp*) install_app "gimp" ;;
  *LibreOffice*) install_app "libreoffice" ;;
  *LocalSend*) install_app "localsend" ;;
  *Obsidian*) install_app "obsidian" ;;
  *Signal*) install_app "signal" ;;
  *Spotify*) install_app "spotify" ;;
  *Typora*) install_app "typora" ;;
  *Tailscale*) install_app "tailscale" ;;
  *Virtualbox*) install_app "virtualbox" ;;
  *Zoom*) install_app "zoom" ;;
  *) show_install_menu ;;
  esac
}

show_install_browser_menu() {
  case $(menu "Install" "  Brave\n  Chromium\n  Firefox\n  Zen" "--width 250 --height 210") in
  *Brave*) install_app "brave" ;;
  *Chromium*) install_app "chromium" ;;
  *Firefox*) install_app "firefox" ;;
  *Zen*) install_app "zen" ;;
  *) show_install_menu ;;
  esac
}

show_install_utility_menu() {
  case $(menu "Install" "  ASDControl\n  Flameshot\n  Pinta\n  Starship\n  Xournalpp" "--width 250 --height 250") in
  *ASDControl*) install_app "asdcontrol" ;;
  *Flameshot*) install_app "flameshot" ;;
  *Pinta*) install_app "pinta" ;;
  *Starship*) install_app "starship" ;;
  *Xournalpp*) install_app "xournalpp" ;;
  *) show_install_menu ;;
  esac
}

show_install_style_menu() {
  case $(menu "Install" "󰸌  Theme\n  Background" "--width 250 --height 130") in
  *Theme*) present_terminal omakub-theme-install ;;
  *Background*) nautilus ~/.config/omakub/current/theme/backgrounds ;;
  *) show_install_menu ;;
  esac
}

show_install_development_menu() {
  case $(menu "Install" "  Docker\n󱘲  Databases\n  Github\n  Gitlab\n󰫏  Ruby on Rails\n  JavaScript\n  Go\n  PHP\n  Python\n  Elixir\n  Zig\n  Rust\n  Java\n  .NET\n  OCaml\n  Clojure" "--width 250 --height 600") in
  *Docker*) install_app "docker" ;;
  *Databases*) present_terminal "omakub-install-docker-dbs" ;;
  *Github*) install_app "github-cli" ;;
  *Gitlab*) install_app "gitlab-cli" ;;
  *Rails*) present_terminal "omakub-install-dev-env ruby" ;;
  *JavaScript*) show_install_javascript_menu ;;
  *Go*) present_terminal "omakub-install-dev-env go" ;;
  *PHP*) present_terminal "omakub-install-dev-env php" ;;
  *Python*) present_terminal "omakub-install-dev-env python" ;;
  *Elixir*) show_install_elixir_menu ;;
  *Zig*) present_terminal "omakub-install-dev-env zig" ;;
  *Rust*) present_terminal "omakub-install-dev-env rust" ;;
  *Java*) present_terminal "omakub-install-dev-env java" ;;
  *NET*) present_terminal "omakub-install-dev-env dotnet" ;;
  *OCaml*) present_terminal "omakub-install-dev-env ocaml" ;;
  *Clojure*) present_terminal "omakub-install-dev-env clojure" ;;
  *) show_install_menu ;;
  esac
}

show_install_javascript_menu() {
  case $(menu "Install" "  Node.js\n  Bun\n  Deno" "--width 250 --height 170") in
  *Node*) present_terminal "omakub-install-dev-env node" ;;
  *Bun*) present_terminal "omakub-install-dev-env bun" ;;
  *Deno*) present_terminal "omakub-install-dev-env deno" ;;
  *) show_install_development_menu ;;
  esac
}

show_install_elixir_menu() {
  case $(menu "Install" "  Elixir\n  Phoenix" "--width 250 --height 130") in
  *Elixir*) present_terminal "omakub-install-dev-env elixir" ;;
  *Phoenix*) present_terminal "omakub-install-dev-env phoenix" ;;
  *) show_install_development_menu ;;
  esac
}

show_install_editor_menu() {
  case $(menu "Install" "  NeoVim\n  VSCode\n  Cursor\n  Zed\n  Emacs" "--width 250 --height 245") in
  *VSCode*) install_app "visual-studio-code" ;;
  *NeoVim*) install_app "neovim" ;;
  *Cursor*) install_app "cursor" ;;
  *Zed*) install_app "zed" ;;
  *Emacs*) install_app "doom-emacs" ;;
  *) show_install_menu ;;
  esac
}

show_install_terminal_menu() {
  case $(menu "Install" "  Alacritty\n  Kitty" "--width 250 --height 130") in
  *Alacritty*) install_terminal "alacritty" ;;
  *Kitty*) install_terminal "kitty" ;;
  *) show_install_menu ;;
  esac
}

show_install_ai_menu() {
  case $(menu "Install" "󱚤  Ollama" "--width 250 --height 80") in
  *Ollama*) install_app "ollama" ;;
  *) show_install_menu ;;
  esac
}

show_install_gaming_menu() {
  case $(menu "Install" "  Steam\n  RetroArch\n󰍳  Minecraft" "--width 250 --height 170") in
  *Steam*) install_app "steam" ;;
  *RetroArch*) install_app "retroarch" ;;
  *Minecraft*) install_app "minecraft" ;;
  *) show_install_menu ;;
  esac
}

show_remove_menu() {
  case $(menu "Remove" "  Web App\n  TUI\n󰀻  App\n󰸌  Theme" "--width 250 --height 210") in
  *Web*) present_terminal omakub-webapp-remove ;;
  *TUI*) present_terminal omakub-tui-remove ;;
  *App*) present_terminal omakub-app-remove ;;
  *Theme*) present_terminal omakub-theme-remove ;;
  *) show_main_menu ;;
  esac
}

show_update_menu() {
  case $(menu "Update" "󰟢  Omakub\n  Config\n󰸌  Themes\n󰇅  Hardware\n  Firmware\n  Password" "--width 250 --height 280") in
  *Omakub*) present_terminal omakub-update ;;
  *Config*) show_update_config_menu ;;
  *Themes*) present_terminal omakub-theme-update ;;
  *Hardware*) show_update_hardware_menu ;;
  *Firmware*) present_terminal omakub-update-firmware ;;
  *Password*) show_update_password_menu ;;
  *) show_main_menu ;;
  esac
}

show_update_config_menu() {
  case $(menu "Use default config" "  Gnome\n󰍂  GDM\n󱣴  Plymouth\n󰌧  Wofi\n  Starship\n  Zellij" "--width 250 --height 280") in
  *Gnome*) present_terminal omakub-refresh-gnome ;;
  *GDM*) present_terminal omakub-refresh-gdm ;;
  *Plymouth*) present_terminal omakub-refresh-plymouth ;;
  *Wofi*) present_terminal omakub-refresh-wofi ;;
  *Starship*) present_terminal omakub-refresh-config starship.toml ;;
  *Zellij*) present_terminal omakub-refresh-config zellij/config.kdl ;;
  *) show_update_menu ;;
  esac
}

show_update_hardware_menu() {
  case $(menu "Restart" "  Audio" "--width 250 --height 80") in
  *Audio*) present_terminal omakub-restart-pipewire ;;
  *) show_update_menu ;;
  esac
}

show_update_password_menu() {
  case $(menu "Update Password" "  User" "--width 250 --height 80") in
  *User*) present_terminal passwd ;;
  *) show_update_menu ;;
  esac
}

show_main_menu() {
  go_to_menu "$(menu "Go" "󰀻  Apps\n󰧑  Learn\n  Style\n  Setup\n󰉉  Install\n󰭌  Remove\n  Update\n  About" "--width 250 --height 360")"
}

go_to_menu() {
  case "${1,,}" in
  *apps*) omakub-apps ;;
  *learn*) show_learn_menu ;;
  *style*) show_style_menu ;;
  *theme*) show_theme_menu ;;
  *setup*) show_setup_menu ;;
  *install*) show_install_menu ;;
  *remove*) show_remove_menu ;;
  *update*) show_update_menu ;;
  *about*) omakub-launch-about ;;
  esac
}

if [[ -n "$1" ]]; then
  BACK_TO_EXIT=true
  go_to_menu "$1"
else
  show_main_menu
fi