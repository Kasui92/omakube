#!/bin/bash

# omakub-launch-webapp: Launch a web application as a standalone window.
# Usage: omakub-launch-webapp <app-url> <app-name>
if [[ -z "$1" || -z "$2" ]]; then
  echo "Usage: omakub-launch-webapp <app-url> <app-name>" >&2
  exit 1
fi

APP_URL="$1"
APP_NAME="$2"
APP_ID=$(echo "$APP_NAME" | sed 's/[^a-zA-Z0-9]//g' | tr '[:upper:]' '[:lower:]')

# This prevents data loss and force to open in a separate profile
OMAKUB_DATA_DIR="$HOME/.config/omakub/webapp"
WEBAPP_DATA_DIR="$OMAKUB_DATA_DIR/$(echo "$APP_NAME" | tr ' ' '-' | tr '[:upper:]' '[:lower:]')"
if [ ! -d "$WEBAPP_DATA_DIR" ]; then
  mkdir -p "$WEBAPP_DATA_DIR"
fi

browser=$(xdg-settings get default-web-browser)

case $browser in
google-chrome* | brave-browser* | microsoft-edge* | opera* | vivaldi* | helium-browser*) ;;
*) browser="chromium.desktop" ;;
esac
BROWSER_EXEC=$(sed -n 's/^Exec=\([^ ]*\).*/\1/p' {~/.local,~/.nix-profile,/usr}/share/applications/$browser 2>/dev/null | head -1)

exec "$BROWSER_EXEC" \
  --user-data-dir="$WEBAPP_DATA_DIR" \
  --window-size=800,600 \
  --app="$APP_URL" \
  --class="$APP_ID" \
  --name="$APP_NAME"
